import PostLayout from "@/components/posts/PostLayout"
import TwitterButton from "@/components/posts/TwitterButton"
import Head from "next/head"

export const meta = {
  title: 'NestJS & GraphQL & Prisma ã‚’ä½¿ã£ãŸçˆ†é€ŸGraphQLã‚µãƒ¼ãƒãƒ¼æ§‹ç¯‰æ–¹æ³•',
  description: 'Prismaã‚’ä½¿ã†ã¨Prismaã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰DBã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚GraphQLã®å‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã‚‚è‡ªå‹•ã§è¡Œãˆã¾ã™ã€‚NestJSã§ã‚‚module, resolver, serviceãŒåŠè‡ªå‹•ã§ç”Ÿæˆã§ãã‚‹ã®ã§ã€Prismaã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã™ã‚Œã°ã»ã¨ã‚“ã©ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãªãGraphQLã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚',
  createdAt: '2022-07-04',
  emoji: 'ğŸ—¼ ',
  categories: ['NestJS', 'GraphQL', 'Prisma', 'backend'],
}

# NestJS & GraphQL & Prisma ã‚’ä½¿ã£ãŸçˆ†é€ŸGraphQLã‚µãƒ¼ãƒãƒ¼æ§‹ç¯‰æ–¹æ³• 

**ğŸ“ Point**
1. prisma-mergeã§Prismaã‚¹ã‚­ãƒ¼ãƒã‚’åˆ†å‰²ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
2. prisma-nestjs-graphqlã§Prismaã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
3. ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ model ã‚’å®šç¾©ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã§ç§»å‹•ã™ã‚‹
4. NestJSã®CLIã§ module, resolver, service ã‚’ä½œæˆã™ã‚‹

## prisma-mergeã‚’ä½¿ã£ã¦ã€Prismaã‚¹ã‚­ãƒ¼ãƒã‚’åˆ†å‰²ã—ã¦ç®¡ç†ã™ã‚‹

prismaã‚¹ã‚­ãƒ¼ãƒã¯ä¸‹è¨˜ã®æ§‹æˆã§åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚

```
.
â””â”€â”€ prisma/
    â”œâ”€â”€ models/
    â”‚   â”œâ”€â”€ user.prisma
    â”‚   â””â”€â”€ post.prisma
    â””â”€â”€ base.prisma
```

`base.prisma` ã«ã¯Prismaã®è¨­å®šã‚’ã€`models/*.prisma` ã«ã¯ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©ã‚’è¨˜è¿°ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```
// base.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["referentialIntegrity"]
}

datasource db {
  provider             = "mysql"
  url                  = env("DATABASE_URL")
  referentialIntegrity = "prisma"
}
```

```
// models/*.prisma

model User {
  id          String   @id
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  avatar      String
  posts       Post[]
}
```

ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`prisma/base.prisma` ã¨ `prisma/**/*.prisma` ã‚’èª­ã¿è¾¼ã‚“ã§ã€`prisma/schema.prisma` ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

```shell
yarn prisma-merge -b prisma/base.prisma -s 'prisma/**/*.prisma' -o prisma/schema.prisma
```

è‡ªåˆ†ã¯ `package.json` ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šç¾©ã—ã¦ã€`yarn merge:prisma` ã ã‘ã§éšæ™‚Prismaã‚¹ã‚­ãƒ¼ãƒã®ç”ŸæˆãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```json
{
  ...,
  "scripts": {
    ...,
    "merge:prisma": "yarn prisma-merge -b prisma/base.prisma -s 'prisma/**/*.prisma' -o prisma/schema.prisma"
  },
}
```

ã¾ãŸã€DBã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚‚å¿˜ã‚Œãšã«ã€‚

```shell
yarn prisma db push
```

## prisma-nestjs-graphqlã‚’ä½¿ã£ã¦ã€Prismaã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹

prisma-nestjs-graphql ã‚’ä½¿ã†ã¨ã€`schema.prisma` ã‹ã‚‰GraphQLã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ç”¨ã„ã‚‹TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆã§ãã¾ã™ã€‚

```shell
yarn add prisma-nestjs-graphql class-transformer
```

`base.prisma` ã«ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
generator nestgraphql {
  provider = "prisma-nestjs-graphql"
  output  = "../src/@generated/prisma-nestjs-graphql"
}
```

ãã—ã¦ã€`yarn merge:prisma` ã§ `schema.prisma` ã‚’ç”Ÿæˆå¾Œã€`yarn prisma generate` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`src/@generated/prisma-nestjs-graphql` ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```shell
yarn merge:prisma
yarn prisma generate
```

## ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ *.model.ts ã‚’ç§»å‹•ã•ã›ã‚‹

ã¾ãšã€ç”Ÿæˆã—ãŸTypeScriptãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šã„ã®ã§ã€`src/@generated` ä»¥ä¸‹ã‚’ `.gitignore` ã«è¿½åŠ ã—ã¾ã™ã€‚

```shell
echo "src/@generated/*" >> .gitignore
```

ãã®å¾Œã€`src/@generated/prisma-nestjs-graphql/*/*.model.ts` ã‚’ç§»å‹•ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚  
`src/@generated/prisma-nestjs-graphql/*/*.model.ts` ã«è©²å½“ã™ã‚‹ãƒ‘ã‚¹ã‚’å‡ºåŠ›ã—ã€ãã®ãƒ‘ã‚¹ã‚’åŠ å·¥ã—ã¦ã€`mkdir` ã«æ¸¡ã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```shell
ls src/@generated/prisma-nestjs-graphql/*/*.model.ts | sed 's/src\/\@generated\/prisma-nestjs-graphql\///g' | sed 's/\/.*//g' | xargs -I {} sh -c 'mkdir src/{}'
```
ç§»å‹•å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãŸã‚‰ã€


```shell
ls src/@generated/prisma-nestjs-graphql/*/*.model.ts | sed 's/src\/\@generated\/prisma-nestjs-graphql\///g' | xargs -I {} sh -c 'cp src/@generated/prisma-nestjs-graphql/{} src/{}'
```

Prismaã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹ãŸã³ã«ã€ä¸Šè¨˜ã®é•·ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã®ã¯é¢å€’ãªã®ã§ã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚  
`~/.zshrc` ã«ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã€ã‚·ã‚§ãƒ«ã§ `copy-prisma-model` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä¸Šè¨˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèµ°ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```shell
function copy-prisma-model() {
  # model.tsã®ç§»å‹•
  echo "make folder"
  ls src/@generated/prisma-nestjs-graphql/*/*.model.ts | sed 's/src\/\@generated\/prisma-nestjs-graphql\///g' | sed 's/\/.*//g' | xargs -I {} sh -c 'mkdir src/{}'
  echo "copy model.ts"
  ls src/@generated/prisma-nestjs-graphql/*/*.model.ts | sed 's/src\/\@generated\/prisma-nestjs-graphql\///g' | xargs -I {} sh -c 'cp src/@generated/prisma-nestjs-graphql/{} src/{}'
}
```

## NestJS ã®CLIã§ module, resolver, service ã‚’ä½œæˆã™ã‚‹

module ã‚’ä½œæˆ

```shell
yarn nest generate module user
```

resolver ã‚’ä½œæˆ

```shell
yarn nest generate resolver user
```

service ã‚’ä½œæˆ

```shell
yarn nest generate service user
```

`src/user/user.resolver.ts` ã‚’ä¿®æ­£

```ts
import { Query, Resolver } from '@nestjs/graphql';
import { User } from './user.model';
import { UserService } from './user.service';

@Resolver()
export class UserResolver {
  constructor(private userService: UserService) {}

  @Query(() => [User], { nullable: 'items' })
  users() {
    return this.userService.getUsers();
  }
}
```

`src/user/user.service.ts` ã‚’ä¿®æ­£

```ts
import { Injectable } from '@nestjs/common';
import { User } from './user.model';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

@Injectable()
export class UserService {
  async getUsers(): Promise<User[]> {
    const result = await prisma.user.findMany({ include: { concerts: true } });
    return result;
  }
}
```

## ãŠã‚ã‚Šã«

ä»¥ä¸Šã§ä¸€é€šã‚ŠNestJS + Prisma + GraphQL ã®æ§‹æˆã§ã‚µãƒ¼ãƒãƒ¼ã‚’å»ºã¦ã‚‹ã“ã¨ãŒã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚  
NestJSã‚’ä½¿ã£ã¦GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’å»ºã¦ã‚‹ã¨ãã®å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

ã”è³ªå•ãƒ»ã”æ„è¦‹ç­‰ã¯ä¸‹è¨˜ã®Twitterã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

<TwitterButton />

export default ({ children }) => <PostLayout meta={meta}>{children}</PostLayout>
